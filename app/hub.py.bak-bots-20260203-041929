import streamlit as st
import json
from pathlib import Path
import subprocess

APP_ROOT = Path(__file__).resolve().parent.parent
REQ_DIR = APP_ROOT / "requirements"

def load_packages_registry():
    reg_path = APP_ROOT / "packages_registry.json"
    if not reg_path.exists():
        return {}
    return json.loads(reg_path.read_text(encoding="utf-8-sig"))

def run_cmd(cmd: str) -> str:
    proc = subprocess.run(
        cmd,
        shell=True,
        capture_output=True,
        text=True,
    )
    return (proc.stdout or proc.stderr or "").strip()

def main():
    st.set_page_config(page_title="AI Training Hub", layout="wide")
    st.title("AI Training Hub")

    registry = load_packages_registry()

    st.subheader("Install Options")
    install_core = st.checkbox("Core packages", value=True)
    install_agents = st.checkbox("Agent frameworks")
    install_rag = st.checkbox("RAG tools")

    st.divider()
    st.subheader("Install Selected")

    st.warning(
        "Installs run inside the Hub's venv. "
        "In managed labs, IT may preinstall these."
    )

    cmds = []
    if install_core:
        cmds.append("python -m pip install -r requirements/requirements-hub.txt")
    if install_agents:
        cmds.append("python -m pip install -r requirements/requirements-agents.txt")
    if install_rag:
        cmds.append("python -m pip install -r requirements/requirements-rag.txt")

    if st.button("Run install"):
        out_all = []
        for c in cmds:
            out_all.append(f"$ {c}\n{run_cmd(c)}")
        joined = "\n\n".join(out_all)
        st.text_area("Output", joined, height=400)

if __name__ == "__main__":
    main()
